{% extends "max/base.html" %}
{% load static %}

{% block title %}{{ node.name|default:"Node Details" }} - MeshCore{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'max/css/node-detail.css' %}">
{% endblock %}

{% block content %}
<div id="app">
    <!-- Navigation Header -->
    <div class="header">
        <a href="/" class="back-link">‚Üê Back to Overview</a>
        <h1>{{ node.name|default:"Unnamed Node" }}</h1>
    </div>

    <!-- Content Area -->
    <div class="content">
        <!-- Node Info Card -->
        <div class="card">
            <h2>Node Information</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Type:</span>
                    <span class="info-value">
                        {% if node.role == 0 %}üì° Repeater{% else %}üì± Client{% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status:</span>
                    <span class="info-value {% if node.is_active %}status-active{% else %}status-inactive{% endif %}">
                        {% if node.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Mesh Identity:</span>
                    <span class="info-value">{{ node.mesh_identity }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Firmware:</span>
                    <span class="info-value">{{ node.firmware_version }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Coverage Range:</span>
                    <span class="info-value">{{ node.estimated_range }}m</span>
                </div>
                <div class="info-item">
                    <span class="info-label">First Seen:</span>
                    <span class="info-value">{{ node.first_seen|date:"Y-m-d H:i" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Seen:</span>
                    <span class="info-value">{{ node.last_seen|date:"Y-m-d H:i" }}</span>
                </div>
                {% if node.description %}
                <div class="info-item full-width">
                    <span class="info-label">Description:</span>
                    <span class="info-value">{{ node.description }}</span>
                </div>
                {% endif %}
            </div>

            {% if node.role == 0 %}
            <!-- Signal Mapping Actions (Repeaters only) -->
            <div class="actions">
                <a href="/mapper/?node={{ node.id }}" class="btn btn-primary">
                    üì° Map the Signal
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Map Card -->
        {% if node.location %}
        <div class="card">
            <h2>Location</h2>
            <div id="map"></div>
            <div class="location-info">
                <div>
                    <strong>Coordinates:</strong>
                    {{ node.latitude|floatformat:6 }}, {{ node.longitude|floatformat:6 }}
                </div>
                {% if node.altitude %}
                <div>
                    <strong>Altitude:</strong>
                    {{ node.altitude|floatformat:2 }}m
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="card">
            <h2>Location</h2>
            <p class="no-data">No location data available for this node.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize map if location exists
    {% if node.location %}
    document.addEventListener('DOMContentLoaded', () => {
        const lat = {{ node.latitude }};
        const lon = {{ node.longitude }};
        const range = {{ node.estimated_range }};
        const isActive = {{ node.is_active|yesno:"true,false" }};

        // Initialize map
        const map = L.map('map').setView([lat, lon], 14);

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);

        // Add coverage circle
        L.circle([lat, lon], {
            radius: range,
            color: isActive ? '#007bff' : '#95a5a6',
            fillColor: isActive ? '#007bff' : '#95a5a6',
            fillOpacity: 0.1,
            weight: 2
        }).addTo(map);

        // Add marker
        const icon = {{ node.role }} === 0 ? 'üì°' : 'üì±';
        const markerIcon = L.divIcon({
            html: `<div style="font-size: 32px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">${icon}</div>`,
            className: 'node-marker',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });

        L.marker([lat, lon], { icon: markerIcon }).addTo(map);
    });
    {% endif %}
</script>
{% endblock %}
