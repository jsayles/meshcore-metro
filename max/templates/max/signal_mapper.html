{% extends "max/base.html" %}
{% load static %}

{% block title %}MeshCore Signal Mapper{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'max/css/signal-mapper.css' %}">
{% endblock %}

{% block content %}
<div id="app">
    <!-- Map Container -->
    <div id="map"></div>

    <!-- Control Sidebar -->
    <div id="sidebar">
        <a href="/" class="back-link">‚Üê Back to Home</a>
        <h1>Signal Mapper</h1>

        <!-- Progress Checklist -->
        <div class="checklist">
            <!-- Step 1: Repeater -->
            <div class="step" id="step-repeater" data-step="1">
                <div class="step-header">
                    <span class="step-number">1</span>
                    <span class="step-title">Repeater</span>
                    <span class="step-status" id="status-repeater"></span>
                </div>
                <div class="step-content" id="content-repeater">
                    <select id="repeater-select" class="select">
                        <option value="">-- Select Repeater --</option>
                    </select>
                </div>
                <div class="step-content" id="content-repeater-selected" style="display: none;">
                    <span id="selected-repeater-name"></span>
                </div>
            </div>

            <!-- Step 2: Location Tracking -->
            <div class="step" id="step-location" data-step="2">
                <div class="step-header">
                    <span class="step-number">2</span>
                    <span class="step-title">Location Tracking</span>
                    <span class="step-status" id="status-location">Waiting...</span>
                </div>
            </div>

            <!-- Step 3: Companion Radio -->
            <div class="step" id="step-radio" data-step="3">
                <div class="step-header">
                    <span class="step-number">3</span>
                    <span class="step-title">Companion Radio</span>
                    <span class="step-status" id="status-radio">Waiting...</span>
                </div>
                <div class="step-content" id="content-radio">
                    <button id="btn-connect" class="btn btn-primary">Connect</button>
                </div>
            </div>
        </div>

        <!-- Session Management Section -->
        <div class="collection-section" id="session-section">
            <h2>Mapping Session</h2>

            <div id="session-start">
                <button id="btn-start-session" class="btn btn-primary">Start Session</button>
                <p class="help-text">Start a mapping session to begin collecting traces</p>
            </div>

            <div id="session-active" style="display: none;">
                <div class="session-info">
                    <div>Status: <span class="badge badge-success">Active</span></div>
                    <div>Started: <span id="session-start-time">-</span></div>
                    <div>Traces collected: <span id="measurement-count">0</span></div>
                </div>
                <button id="btn-end-session" class="btn btn-danger">End Session</button>
            </div>
        </div>

        <!-- Collect Measurements Section -->
        <div class="collection-section" id="collection-section">
            <h2>Collect Measurements</h2>

            <div id="content-collect">
                <div class="mode-toggle">
                    <label>
                        <input type="radio" name="mode" value="manual" checked>
                        Manual
                    </label>
                    <label>
                        <input type="radio" name="mode" value="continuous">
                        Continuous
                    </label>
                </div>

                <div id="continuous-options" style="display: none;">
                    <label for="interval">Interval (seconds):</label>
                    <input type="number" id="interval" min="1" max="60" value="5" class="input">
                </div>

                <div class="button-group">
                    <button id="btn-collect" class="btn btn-success">Send Trace</button>
                    <button id="btn-start-continuous" class="btn btn-success" style="display: none;">Start Collection</button>
                    <button id="btn-stop-continuous" class="btn btn-danger" style="display: none;">Stop Collection</button>
                </div>

                <!-- Trace Status -->
                <div id="trace-status" style="margin-top: 10px; font-size: 0.9em;"></div>

                <!-- Measurement Stats -->
                <div class="measurement-stats">
                    <h3>Last Trace</h3>
                    <div>Time: <span id="trace-time">-</span></div>
                    <div>Duration: <span id="trace-duration">-</span></div>
                    <div>SNR to target: <span id="snr-to-target">-</span> dB</div>
                    <div>SNR from target: <span id="snr-from-target">-</span> dB</div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-messages"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load modules as type=module for modern browsers -->
<script type="module" src="{% static 'max/js/ws-connection.js' %}"></script>
<script type="module" src="{% static 'max/js/measurement-collector.js' %}"></script>
<script type="module" src="{% static 'max/js/heatmap-renderer.js' %}"></script>
<script type="module" src="{% static 'max/js/signal-mapper.js' %}"></script>
<script type="module">
    import { SignalMapper } from "{% static 'max/js/signal-mapper.js' %}";

    document.addEventListener('DOMContentLoaded', () => {
        const app = new SignalMapper();
        app.init();
    });
</script>
{% endblock %}
