{% extends "metro/base.html" %}
{% load static %}

{% block title %}MeshCore Field Testing{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'metro/css/field-testing.css' %}">
{% endblock %}

{% block content %}
<div id="app">
    <!-- Map Container -->
    <div id="map"></div>

    <!-- Control Sidebar -->
    <div id="sidebar">
        <h1>Field Testing</h1>

        <!-- Progress Checklist -->
        <div class="checklist">
            <!-- Initialization Box -->
            <div class="step init-box" id="step-init" data-step="init">
                <div class="step-header">
                    <span class="step-title">Initialization</span>
                </div>
                <div class="init-content">
                    <!-- Step 1: Repeater -->
                    <div class="init-item">
                        <span class="init-label">Repeater:</span>
                        <div class="init-value">
                            <select id="repeater-select" class="select" style="display: inline-block;">
                                <option value="">-- Select --</option>
                            </select>
                            <span id="status-repeater" class="init-status"></span>
                        </div>
                    </div>

                    <!-- Step 2: Location Tracking -->
                    <div class="init-item">
                        <span class="init-label">Location:</span>
                        <span id="status-location" class="init-status">Waiting...</span>
                    </div>

                    <!-- Step 3: WebSocket Connection -->
                    <div class="init-item">
                        <span class="init-label">WebSocket:</span>
                        <span id="status-websocket" class="init-status">Waiting...</span>
                    </div>

                    <!-- Step 4: Radio Connection -->
                    <div class="init-item">
                        <span class="init-label">Radio:</span>
                        <span id="status-radio" class="init-status">Waiting...</span>
                        <button id="btn-retry-radio" class="btn btn-primary btn-sm" style="display: none; margin-left: 8px;">Retry Radio</button>
                    </div>

                    <!-- Connect Button -->
                    <div class="init-item" style="margin-top: 8px;">
                        <button id="btn-connect" class="btn btn-primary btn-sm" style="display: none; width: 100%;">Connect</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Radio Warning Box -->
        <div id="radio-warning" class="warning-box" style="display: none;">
            <div class="warning-header">
                <span class="warning-icon">⚠️</span>
                <span class="warning-title">Radio Not Connected</span>
            </div>
            <p id="radio-error-message" class="warning-message">
                Could not connect to companion radio.
            </p>
            <p class="warning-help">
                Please check that the MeshCore radio is connected via USB and powered on.
            </p>
        </div>

        <!-- Session Management Section -->
        <div class="collection-section" id="session-section">
            <h2>Mapping Session</h2>

            <div id="session-start">
                <button id="btn-start-session" class="btn btn-primary">Start Session</button>
                <p class="help-text">Start a mapping session to begin collecting traces</p>
            </div>

            <div id="session-active" style="display: none;">
                <div class="session-info">
                    <div>Status: <span class="badge badge-success">Active</span></div>
                    <div>Started: <span id="session-start-time">-</span></div>
                    <div>Traces collected: <span id="measurement-count">0</span></div>
                </div>
                <button id="btn-end-session" class="btn btn-danger">End Session</button>
            </div>
        </div>

        <!-- Collect Measurements Section -->
        <div class="collection-section" id="collection-section">
            <h2>Collect Measurements</h2>

            <div id="content-collect">
                <div class="mode-toggle">
                    <label>
                        <input type="radio" name="mode" value="manual" checked>
                        Manual
                    </label>
                    <label>
                        <input type="radio" name="mode" value="continuous">
                        Continuous
                    </label>
                </div>

                <div id="continuous-options" style="display: none;">
                    <label for="interval">Interval (seconds):</label>
                    <input type="number" id="interval" min="1" max="300" value="30" class="input">
                </div>

                <div class="button-group">
                    <button id="btn-collect" class="btn btn-success">Send Trace</button>
                    <button id="btn-start-continuous" class="btn btn-success" style="display: none;">Start Collection</button>
                    <button id="btn-stop-continuous" class="btn btn-danger" style="display: none;">Stop Collection</button>
                </div>

                <!-- Trace Status -->
                <div id="trace-status" style="margin-top: 10px; font-size: 0.9em;"></div>

                <!-- Measurement Stats -->
                <div class="measurement-stats">
                    <h3>Last Trace</h3>
                    <div>Time: <span id="trace-time">-</span></div>
                    <div>Duration: <span id="trace-duration">-</span></div>
                    <div>SNR to target: <span id="snr-to-target">-</span> dB</div>
                    <div>SNR from target: <span id="snr-from-target">-</span> dB</div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-messages"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load modules as type=module for modern browsers -->
<script type="module" src="{% static 'metro/js/ws-connection.js' %}"></script>
<script type="module" src="{% static 'metro/js/measurement-collector.js' %}"></script>
<script type="module" src="{% static 'metro/js/heatmap-renderer.js' %}"></script>
<script type="module" src="{% static 'metro/js/field-testing.js' %}"></script>
<script type="module">
    import { FieldTester } from "{% static 'metro/js/field-testing.js' %}";

    document.addEventListener('DOMContentLoaded', () => {
        const app = new FieldTester();
        app.init();
    });
</script>
{% endblock %}
